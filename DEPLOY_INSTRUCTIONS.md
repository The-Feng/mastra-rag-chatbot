# Cloudflare Workers éƒ¨ç½²è¯´æ˜

## ğŸ¯ å½“å‰çŠ¶æ€

### âœ… å·²å®Œæˆé…ç½®

1. **ç²¾ç®€ç‰ˆ Worker** (`src/worker-minimal.ts`)
   - åªåŒ…å«åŸºæœ¬èŠå¤©åŠŸèƒ½
   - ç§»é™¤äº† RAGã€æ–‡ä»¶ä¸Šä¼ ã€å›¾åƒåˆ†æç­‰å¤§å‹ä¾èµ–
   - å¤§å¹…å‡å°æ–‡ä»¶å¤§å°

2. **å®Œæ•´ç‰ˆ Worker** (`src/worker.ts`)
   - åŒ…å«æ‰€æœ‰åŠŸèƒ½ï¼ˆRAGã€æ–‡ä»¶ä¸Šä¼ ã€å›¾åƒåˆ†æï¼‰
   - æ–‡ä»¶è¾ƒå¤§ï¼ˆçº¦ 6.9MB æœªå‹ç¼©ï¼‰
   - éœ€è¦ä»˜è´¹è®¡åˆ’æ‰èƒ½éƒ¨ç½²

3. **æ„å»ºè„šæœ¬**
   - `build:worker` - æ„å»ºç²¾ç®€ç‰ˆï¼ˆæ¨èï¼‰
   - `build:worker:full` - æ„å»ºå®Œæ•´ç‰ˆ

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### æ­¥éª¤ 1: é€‰æ‹©éƒ¨ç½²ç‰ˆæœ¬

#### é€‰é¡¹ A: ç²¾ç®€ç‰ˆï¼ˆæ¨èï¼Œé€‚åˆå…è´¹è®¡åˆ’ï¼‰

```bash
pnpm run build:worker
pnpm run deploy:worker
```

**åŠŸèƒ½**:
- âœ… åŸºæœ¬èŠå¤©ï¼ˆä½¿ç”¨ GPT-4o-miniï¼‰
- âœ… å¥åº·æ£€æŸ¥ç«¯ç‚¹
- âœ… ç®€å•çš„ Web ç•Œé¢
- âŒ æ–‡ä»¶ä¸Šä¼ /RAG
- âŒ å›¾åƒåˆ†æ

**ä¼˜ç‚¹**:
- æ–‡ä»¶å°ï¼Œé€‚åˆå…è´¹è®¡åˆ’
- éƒ¨ç½²å¿«é€Ÿ
- è¿è¡Œç¨³å®š

#### é€‰é¡¹ B: å®Œæ•´ç‰ˆï¼ˆéœ€è¦ä»˜è´¹è®¡åˆ’ï¼‰

```bash
pnpm run build:worker:full
pnpm run deploy:worker
```

**åŠŸèƒ½**:
- âœ… æ‰€æœ‰åŠŸèƒ½
- âœ… æ–‡ä»¶ä¸Šä¼ å’Œ RAG
- âœ… å›¾åƒåˆ†æ
- âœ… å®Œæ•´çš„èŠå¤©åŠŸèƒ½

**è¦æ±‚**:
- Cloudflare Workers ä»˜è´¹è®¡åˆ’ï¼ˆ$5/æœˆï¼‰
- æ”¯æŒæœ€å¤§ 10 MiB bundle

### æ­¥éª¤ 2: ç¡®è®¤ç™»å½•çŠ¶æ€

```bash
npx wrangler whoami
```

å¦‚æœæœªç™»å½•ï¼š

```bash
npx wrangler login
```

### æ­¥éª¤ 3: éƒ¨ç½²

```bash
# éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
pnpm run deploy:worker

# æˆ–éƒ¨ç½²åˆ°é¢„å‘å¸ƒç¯å¢ƒ
pnpm run deploy:worker:staging
```

### æ­¥éª¤ 4: è®¾ç½®ç¯å¢ƒå˜é‡

éƒ¨ç½²æˆåŠŸåï¼Œåœ¨ Cloudflare Dashboard ä¸­è®¾ç½®ç¯å¢ƒå˜é‡ï¼š

1. è®¿é—® https://dash.cloudflare.com/
2. è¿›å…¥ **Workers & Pages**
3. é€‰æ‹©ä½ çš„ Workerï¼ˆ`mastra-agent` æˆ– `mastra-agent-staging`ï¼‰
4. ç‚¹å‡» **Settings** â†’ **Variables**
5. æ·»åŠ ç¯å¢ƒå˜é‡ï¼š
   - `OPENAI_API_KEY`: ä½ çš„ OpenAI API Key

**æ³¨æ„**: ç²¾ç®€ç‰ˆä¸éœ€è¦ `POSTGRES_URL`

## ğŸ“Š ç‰ˆæœ¬å¯¹æ¯”

| åŠŸèƒ½ | ç²¾ç®€ç‰ˆ | å®Œæ•´ç‰ˆ |
|------|--------|--------|
| åŸºæœ¬èŠå¤© | âœ… | âœ… |
| æ–‡ä»¶ä¸Šä¼  | âŒ | âœ… |
| RAG é—®ç­” | âŒ | âœ… |
| å›¾åƒåˆ†æ | âŒ | âœ… |
| æ–‡ä»¶å¤§å° | ~200KB | ~7MB |
| å…è´¹è®¡åˆ’ | âœ… | âŒ |
| ä»˜è´¹è®¡åˆ’ | âœ… | âœ… |

## âš ï¸ å·²çŸ¥é—®é¢˜

### "fetch failed" é”™è¯¯

**ç—‡çŠ¶**: éƒ¨ç½²æ—¶å‡ºç° "fetch failed" é”™è¯¯

**å¯èƒ½åŸå› **:
1. ç½‘ç»œè¿æ¥é—®é¢˜
2. Cloudflare API æš‚æ—¶ä¸å¯ç”¨
3. è®¤è¯ token è¿‡æœŸ

**è§£å†³æ–¹æ¡ˆ**:
1. æ£€æŸ¥ç½‘ç»œè¿æ¥
2. é‡æ–°ç™»å½•:
   ```bash
   npx wrangler logout
   npx wrangler login
   ```
3. ç¨åé‡è¯•
4. æ£€æŸ¥ Cloudflare çŠ¶æ€é¡µé¢: https://www.cloudflarestatus.com/

### æ–‡ä»¶å¤§å°è¶…é™

**ç—‡çŠ¶**: "Worker exceeded the size limit of 3 MiB"

**è§£å†³æ–¹æ¡ˆ**:
1. ä½¿ç”¨ç²¾ç®€ç‰ˆ Worker
2. æˆ–å‡çº§åˆ°ä»˜è´¹è®¡åˆ’

## ğŸ§ª æµ‹è¯•éƒ¨ç½²

éƒ¨ç½²æˆåŠŸåï¼Œæµ‹è¯•ç«¯ç‚¹ï¼š

### å¥åº·æ£€æŸ¥

```bash
curl https://mastra-agent.your-subdomain.workers.dev/health
```

é¢„æœŸå“åº”:
```json
{
  "status": "ok",
  "version": "1.0.0"
}
```

### èŠå¤©æµ‹è¯•

```bash
curl -X POST https://mastra-agent.your-subdomain.workers.dev/api/chat \
  -H "Content-Type: application/json" \
  -d '{"query":"Hello, how are you?"}'
```

## ğŸ“ ç«¯ç‚¹åˆ—è¡¨

### ç²¾ç®€ç‰ˆ

- `GET /` - ç®€å•çš„ HTML é¡µé¢
- `GET /health` - å¥åº·æ£€æŸ¥
- `POST /api/chat` - èŠå¤©ç«¯ç‚¹ï¼ˆæµå¼å“åº”ï¼‰

### å®Œæ•´ç‰ˆ

- `GET /` - å®Œæ•´çš„ Web ç•Œé¢
- `GET /health` - å¥åº·æ£€æŸ¥
- `POST /api/chat` - èŠå¤©ç«¯ç‚¹ï¼ˆå¸¦ RAGï¼‰
- `POST /api/upload` - æ–‡ä»¶ä¸Šä¼ ç«¯ç‚¹
- `POST /api/image` - å›¾åƒåˆ†æç«¯ç‚¹

## ğŸ”„ æ›´æ–°éƒ¨ç½²

æ›´æ–°ä»£ç åé‡æ–°éƒ¨ç½²ï¼š

```bash
# ç²¾ç®€ç‰ˆ
pnpm run build:worker
pnpm run deploy:worker

# å®Œæ•´ç‰ˆ
pnpm run build:worker:full
pnpm run deploy:worker
```

## ğŸ’¡ æ¨è

å¯¹äºå¤§å¤šæ•°ç”¨æˆ·ï¼Œå»ºè®®ï¼š

1. **å…ˆéƒ¨ç½²ç²¾ç®€ç‰ˆ**ï¼ŒéªŒè¯éƒ¨ç½²æµç¨‹
2. æµ‹è¯•åŸºæœ¬åŠŸèƒ½
3. å¦‚æœéœ€è¦å®Œæ•´åŠŸèƒ½ï¼Œå‡çº§åˆ°ä»˜è´¹è®¡åˆ’å¹¶éƒ¨ç½²å®Œæ•´ç‰ˆ

## ğŸ“ è·å–å¸®åŠ©

å¦‚æœé‡åˆ°é—®é¢˜ï¼š

1. æ£€æŸ¥ Wrangler æ—¥å¿—ï¼ˆé”™è¯¯ä¿¡æ¯ä¸­ä¼šæ˜¾ç¤ºè·¯å¾„ï¼‰
2. æŸ¥çœ‹ Cloudflare Dashboard ä¸­çš„ Worker æ—¥å¿—
3. ä½¿ç”¨ `wrangler tail` å®æ—¶æŸ¥çœ‹æ—¥å¿—:
   ```bash
   npx wrangler tail
   ```

## ğŸ‰ æˆåŠŸéƒ¨ç½²å

1. å°† Worker URL ä¿å­˜ä¸‹æ¥
2. è®¾ç½®ç¯å¢ƒå˜é‡
3. æµ‹è¯•æ‰€æœ‰ç«¯ç‚¹
4. ï¼ˆå¯é€‰ï¼‰è®¾ç½®è‡ªå®šä¹‰åŸŸå

---

**å½“å‰æ¨è**: ä½¿ç”¨ç²¾ç®€ç‰ˆ Workerï¼Œé€‚åˆå¿«é€Ÿéƒ¨ç½²å’Œæµ‹è¯•ã€‚

