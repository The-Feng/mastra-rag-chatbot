name: Deploy to Cloudflare Pages

on:
  push:
    branches:
      - master
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy Pages
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Generate config.js
        run: |
          # ä»ç¯å¢ƒå˜é‡æˆ– secrets è·å– Workers URL
          WORKER_URL="${{ secrets.CLOUDFLARE_WORKER_URL }}"
          if [ -z "$WORKER_URL" ]; then
            # å¦‚æœæ²¡æœ‰è®¾ç½®ï¼Œä½¿ç”¨é»˜è®¤å€¼ï¼ˆPages å’Œ Workers åœ¨åŒä¸€åŸŸåï¼‰
            WORKER_URL=""
            echo "âš ï¸ Warning: CLOUDFLARE_WORKER_URL not set, using relative paths"
          fi
          
          # ç”Ÿæˆ config.jsï¼ˆä½¿ç”¨ Node.js ç¡®ä¿è·¨å¹³å°å…¼å®¹ï¼‰
          node -e "
            const fs = require('fs');
            const workerUrl = process.env.WORKER_URL || '';
            const config = \`// Auto-generated config for Cloudflare Pages
          // This file is generated during deployment
          window.API_BASE_URL = '\${workerUrl}';
          \`;
            fs.writeFileSync('public/config.js', config);
            console.log('âœ… Generated config.js with API_BASE_URL:', workerUrl || '(empty - using relative paths)');
          "
        env:
          WORKER_URL: ${{ secrets.CLOUDFLARE_WORKER_URL }}

      - name: Create Pages project if not exists
        run: |
          PROJECT_NAME="mastra-agent"
          ACCOUNT_ID="${{ secrets.CLOUDFLARE_ACCOUNT_ID }}"
          API_TOKEN="${{ secrets.CLOUDFLARE_API_TOKEN }}"
          
          echo "ğŸ” Checking if Pages project '${PROJECT_NAME}' exists..."
          
          # æ£€æŸ¥é¡¹ç›®æ˜¯å¦å­˜åœ¨
          HTTP_CODE=$(curl -s -o /tmp/check_response.json -w "%{http_code}" -X GET \
            "https://api.cloudflare.com/client/v4/accounts/${ACCOUNT_ID}/pages/projects/${PROJECT_NAME}" \
            -H "Authorization: Bearer ${API_TOKEN}" \
            -H "Content-Type: application/json")
          
          RESPONSE=$(cat /tmp/check_response.json)
          echo "Response HTTP code: ${HTTP_CODE}"
          
          # å¦‚æœé¡¹ç›®ä¸å­˜åœ¨ï¼ˆ404 æˆ– 8000007 é”™è¯¯ä»£ç ï¼‰ï¼Œåˆ™åˆ›å»ºå®ƒ
          if [ "${HTTP_CODE}" = "404" ] || echo "$RESPONSE" | grep -q '"code":8000007'; then
            echo "ğŸ“¦ Project not found, creating Pages project: ${PROJECT_NAME}"
            
            CREATE_RESPONSE=$(curl -s -X POST \
              "https://api.cloudflare.com/client/v4/accounts/${ACCOUNT_ID}/pages/projects" \
              -H "Authorization: Bearer ${API_TOKEN}" \
              -H "Content-Type: application/json" \
              -d "{\"name\":\"${PROJECT_NAME}\",\"production_branch\":\"master\"}")
            
            echo "Create response: ${CREATE_RESPONSE}"
            
            if echo "$CREATE_RESPONSE" | grep -q '"success":true'; then
              echo "âœ… Project created successfully"
            elif echo "$CREATE_RESPONSE" | grep -q '"code":1004'; then
              echo "âš ï¸ Project may already exist (duplicate name), continuing..."
            else
              echo "âš ï¸ Failed to create project, but continuing deployment..."
              echo "Full response: ${CREATE_RESPONSE}"
            fi
          elif [ "${HTTP_CODE}" = "200" ]; then
            echo "âœ… Project already exists"
          else
            echo "âš ï¸ Unexpected response (HTTP ${HTTP_CODE}), but continuing..."
            echo "Response: ${RESPONSE}"
          fi
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Deploy to Cloudflare Pages
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: mastra-agent
          directory: public
          # å¯é€‰ï¼šè®¾ç½®ç”Ÿäº§åˆ†æ”¯
          # production: true

